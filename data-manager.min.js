/*! data-manager - v0.8.0
 * https://github.com/CSNW/DataManager
 * License: MIT
 */

!function(_,n,d3,t){"use strict";var e=function n(){this.cache={},this.types=_.clone(n.types)},r=t.DataManager=e;r.Store=e,e.types={Number:function(n){return+n},Boolean:function(n){return n.toUpperCase?"TRUE"===n.toUpperCase():1===n||!0===n},String:function(n){return null==n?"":""+n},Date:function(n){return new Date(n)}},e.load=function(t){return new n.Promise(function(n,e){d3.csv(t).get(function(t,r){if(t)return e(t);n(r)})})},e.processRows=function(n,t){var e=n._cast||t._cast,r=n._map||t._map;if(e||r){for(var u=n.values,i=-1,o=u.length,a=r?r.count:1,c=new Array(o*a);++i<o;)c[i*a]=e?e(u[i],i,n):u[i],r&&r(c,i*a,c[i*a],i,n);n.values=c}return n.values},e.generateMap=function(n){var t;if(n=n||{},_.isFunction(n))return(t=function(t,e,r,u,i){t[e]=n(r,u,i)}).count=1,t;var e=[],r=[];_.each(n,function(n,t){_.isObject(n)?r.push(_.extend({to:t},n)):e.push({to:t,from:n})}),r.length&&(r=_.reduce(r,function(n,t){return _.chain(n).map(function(n){return _.map(t.columns,function(e){var r={};return t.categories?r=t.categories[e]:t.category&&(r[t.category]=e),{mapping:n.mapping.concat([{from:e,to:t.to}]),categories:_.extend({},n.categories,r)}})}).flatten(!0).value()},[{mapping:[],categories:{}}]));var u="";e.length&&(u+=_.map(e,function(n){return"row['"+n.to+"'] = "+a.resolve(n.from)+";"}).join("\n"),r.length?u+="\n\n":u+="out[cursor] = row;"),r.length&&(u+=_.map(r,function(n,t,e){return"out[cursor + "+t+"] = "+(t>0?"clone(row)":"row")+";"}).join("\n")+"\n\n",u+=_.map(r,function(n,t){return _.map(n.mapping,function(n){return"out[cursor + "+t+"]['"+n.to+"'] = "+a.resolve(n.from)+";"}).join("\n")+"\n"+_.map(n.categories,function(n,e){return"out[cursor + "+t+"]['"+e+"'] = "+a.value(n)+";"}).join("\n")}).join("\n\n"));var i=new Function("resolve","clone","out","cursor","row","index",u);return(t=function(n,t,e,r,u){if(e)return i(o.resolve,o.cloneObject,n,t,e,r)}).count=r.length||1,t},e.generateCast=function(n,t){if(_.isFunction(n))return n;var e={};_.each(n,function(n,r){e[r]=_.isFunction(n)?n:t[n]});var r=_.map(_.keys(e),function(n){return"row['"+n+"'] = cast_options['"+n+"'](row['"+n+"'], index, details);"}).join("\n"),u=new Function("cast_options","row","index","details",r+="return row;");return function(n,t,r){if(n)return u(e,n,t,r)}},_.extend(e.prototype,{values:function(){return new n.Promise(function(n){n(this.cache)}.bind(this))},load:function(t,r){var u=_.isArray(t)?t:[t];(r=r||{}).cast&&(r._cast=e.generateCast(r.cast,this.types)),r.map&&(r._map=e.generateMap(r.map));var i=_.map(u,function(t){var u=this.cache[t];return u||(u=this.cache[t]={filename:t,values:[]}),_.extend(u,r),u.loaded?(r.cast||r.map)&&(u.loading=new n.Promise(function(n,t){_.defer(function(){try{e.processRows(u,this),u.loading=null,n(u.values)}catch(n){t(n)}}.bind(this))}.bind(this))):u.loading||(u.loading=e.load(t).then(function(n){return u.values=n,e.processRows(u,this),u.loading=null,u.loaded=new Date,u.values}.bind(this))),u.loading},this);return n.all(i).then(function(){return _.pick(this.cache,u)}.bind(this))},cast:function(n){return this._cast=e.generateCast(n,this.types),this},map:function(n){return this._map=e.generateMap(n),this},query:function(n){return new u(this,n)}});var u=r.Query=function(t,e){this.store=t,this.promise=new n.Promise(function(n){n(t.cache)}),e&&this.from(e.from)._then(function(n){return _.flatten(_.pluck(_.values(n),"values"))}).preprocess(e.preprocess).filter(e.filter).groupBy(e.groupBy).reduce(e.reduce).postprocess(e.postprocess).series(e.series)};_.extend(u.prototype,{then:function(){return this.promise.then.apply(this.promise,arguments)},_then:function(){return this.promise=this.promise.then.apply(this.promise,arguments),this},catch:function(){return this.promise.catch.apply(this.promise,arguments)},from:function(n){return n?this._then(function(){return this.store.load(n)}.bind(this)):this},preprocess:function(n){return n?this._then(function(t){return n(t)}):this},filter:function(t){return t?this._then(function(e){return _.isFunction(t)?_.filter(e,t):new n.Promise(function(n,r){_.defer(function(){var r=i(t);n(_.filter(e,r))})})}):this},groupBy:function(n){return this._then(function(t){if(n){var e={},r={};_.isString(n)&&(n=[n]),_.isArray(n)&&(n=_.object(n,_.map(n,function(n){return function(t){return t[n]}})));var u=[],i=[];return _.each(n,function(n,t){u.push(t),i.push(n)}),_.each(t,function(n,t,a){var c=o.quickKey(n,u,i);r[c]||(r[c]=_.object(u,_.map(u,function(t,e){return i[e](n)})),e[c]=[]),e[c].push(n)}),e=_.map(e,function(n,t){return{meta:r[t],values:n}})}return[{meta:{},values:t}]})},reduce:function(n){return n?this._then(function(t){var e={avg:function(n,t){return e.sum(n,t)/n.length},sum:function(n,t){return _.reduce(n,function(n,e){return 0+n+e[t]},0)}};return _.each(t,function(t){var r={};_.isFunction(n.iterator)?(r=_.reduce(t.values,n.iterator,n.memo||{}),t.values=[r]):n.byColumn?(_.each(n.byColumn,function(n,u){r[u]=e[n](t.values,u)}),t.values=[r]):n.columns&&n.approach&&(_.each(n.columns,function(u){r[u]=e[n.approach](t.values,u)}),t.values=[r])}),t}):this},postprocess:function(t){return t?this._then(function(e){return n.all(_.map(e,function(n){return t(n.values,n.meta)})).then(function(n){return _.each(e,function(t,e){null!=n[e]&&(t.values=n[e])}),e})}):this},series:function(n){return this._then(function(t){return n?_.isArray(n)?t=_.map(n,e):(_.each(n,function(t,r){n[r]=_.map(t,e)}),t=n):_.each(t,function(n,t){n.key="series-"+t,n.name=_.reduce(n.meta,function(n,t,e){var r=e+"="+t;return n.length?n+", "+r:r},"")}),t;function e(n){var e=i(n.meta),r=_.find(t,function(n){return e(n.meta)});return n.values=r&&r.values||[],n}})}});var i=r.matcher=function(n){function t(n,u,i){var o=e[n]||r[n];return o?o(u,i):_.isObject(u)&&!(u instanceof Date)&&!_.isArray(u)?t("$and",u,n):a.equal(n,u)}var e={$and:function(n,e){return"("+_.map(n,function(n,r){return t(r,n,e)}).join(") && (")+")"},$or:function(n,e){return"("+_.map(n,function(n,r){return t(r,n,e)}).join(") || (")+")"},$not:function(n,e){return"!(("+_.map(n,function(n,r){return t(r,n,e)}).join(") && (")+"))"},$nor:function(n,e){return"!("+_.map(n,function(n,r){return t(r,n,e)}).join(") && !(")+")"}},r={$gt:function(n,t){return a.resolve(t)+" > "+a.value(n)},$gte:function(n,t){return a.resolve(t)+" >= "+a.value(n)},$lt:function(n,t){return a.resolve(t)+" < "+a.value(n)},$lte:function(n,t){return a.resolve(t)+" <= "+a.value(n)},$in:function(n,t){return a.indexOf(t,n)+" >= 0"},$ne:function(n,t){return"!"+a.equal(t,n)},$nin:function(n,t){return a.indexOf(t,n)+" === -1"}},u=new Function("row","resolve","equal","indexOf","return "+t("$and",n)+";");return function(n){return!!n&&u(n,o.resolve,o.equal,o.indexOf)}},o=r.utils={};o.resolve=function(n,t){if(n){if(n[t])return n[t];var e=t.split(".");return _.reduce(e,function(n,t){return n&&n[t]},n)}},o.quickKey=function(n,t,e){for(var r=[],u=0,i=t.length;u<i;u++)r.push(t[u]+":"+e[u](n));return r.join("&")},o.cloneObject=function(n){var t={};for(var e in n)t[e]=n[e];return t},o.equal=_.isEqual,o.indexOf=_.indexOf;var a=r.builder={};a.value=function(n){return _.isString(n)?"'"+n+"'":n instanceof Date?"new Date('"+n.toJSON()+"')":_.isObject(n)?JSON.stringify(n):n},a.resolve=function(n){return n.indexOf(".")>=0?"resolve(row, '"+n+"')":"row['"+n+"']"},a.equal=function(n,t){return"equal("+a.resolve(n)+", "+a.value(t)+")"},a.indexOf=function(n,t){return"indexOf("+a.value(t)+", "+a.resolve(n)+")"}}(_,RSVP,d3,"undefined"!=typeof global?global:this);
//# sourceMappingURL=data-manager.min.js.map