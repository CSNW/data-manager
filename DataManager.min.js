/*! DataManager - v0.6.0
 * https://github.com/CSNW/DataManager
 * License: MIT
 */

!function(_,a,d3,b){"use strict";function c(a,b,c){for(var d=[],e=0,f=b.length;f>e;e++)d.push(b[e]+":"+c[e](a));return d.join("&")}var d=function i(){this.cache={},this.types=_.clone(i.types),this._cast=i.generateCast(function(a){return a}),this._map=i.generateMap(function(a){return a})},e=b.DataManager=d;e.Store=d,d.types={Number:function(a){return+a},Boolean:function(a){return _.isString(a)?"TRUE"===a.toUpperCase():1===a||a===!0},String:function(a){return _.isUndefined(a)?"":""+a},Date:function(a){return new Date(a)}},d.load=function(b){return new a.Promise(function(a,c){d3.csv(b).get(function(b,d){return b?c(b):void a(d)})})},d.processRows=function(a,b){var c=a._cast||b._cast,d=a._map||b._map;return a.values=a.raw,a.values=_.compact(_.flatten(_.map(a.values,function(d,e){return c.call(b,d,e,a,b.types)}),!0)),a.values=_.reduce(a.values,function(c,e,f){return d.call(b,c,e,f,a)},[]),a.values},d.generateMap=function(a){if(a=a||{},_.isFunction(a))return function(b,c,d,e){return b.push(a.call(this,c,d,e)),b};var b=[],c=[],d=[];return _.each(a,function(a,e){_.isObject(a)?(c.push(_.defaults({to:e},a,{category:"__yColumn"})),d=d.concat(a.columns)):(b.push({to:e,from:a}),d.push(a))}),function(a,e){var f=_.omit(e,d);if(_.each(b,function(a){f[a.to]=h(e,a.from)}),c.length){var g=[f];_.each(c,function(a){var b=g;g=[],_.each(b,function(b){_.each(a.columns,function(c){var d=h(e,c);if(null!=d){var f=a.categories&&a.categories[c],i=_.extend({},b,f);i[a.to]=d,a.categories||(i[a.category]=c),g.push(i)}})})}),_.each(g,function(b){a.push(b)})}else a.push(f);return a}},d.generateCast=function(a){return _.isFunction(a)?a:function(b,c,d,e){return _.each(a,function(a,c){var d=_.isFunction(a)?a:e[a];d&&(b[c]=d(b[c]))}),b}},d.prototype={values:function(){return new a.Promise(function(a){a(this.cache)}.bind(this))},load:function(b,c){var e=_.isArray(b)?b:[b];c=c||{},c.cast&&(c._cast=d.generateCast(c.cast)),c.map&&(c._map=d.generateMap(c.map));var f=_.map(e,function(b){var e=this.cache[b];return e||(e=this.cache[b]={filename:b,raw:[],values:[]}),_.extend(e,c),e.loaded?(c.cast||c.map)&&(e.loading=new a.Promise(function(a,b){_.defer(function(){try{d.processRows(e,this),e.loading=null,a(e.values)}catch(c){b(c)}}.bind(this))}.bind(this))):e.loading||(e.loading=d.load(b).then(function(a){return e.raw=a,d.processRows(e,this),e.loading=null,e.loaded=new Date,e.values}.bind(this))),e.loading},this);return a.all(f).then(function(){return _.pick(this.cache,e)}.bind(this))},cast:function(a){return this._cast=d.generateCast(a),_.each(this.cache,function(a){a.cast||d.processRows(a,this)},this),this},map:function(a){return this._map=d.generateMap(a),_.each(this.cache,function(a){a.map||d.processRows(a,this)},this),this},query:function(a){return new f(this,a)}};var f=e.Query=function(b,c){this.store=b,this.promise=new a.Promise(function(a){a(b.cache)}),c&&this.from(c.from).then(function(a){return _.flatten(_.pluck(_.values(a),"values"))}).preprocess(c.preprocess).filter(c.filter).groupBy(c.groupBy).reduce(c.reduce).postprocess(c.postprocess).series(c.series)};f.prototype={then:function(){return this.promise=this.promise.then.apply(this.promise,arguments),this},"catch":function(){return this.promise=this.promise["catch"].apply(this.promise,arguments),this},"finally":function(){return this.promise=this.promise["finally"].apply(this.promise,arguments),this},from:function(a){return a?this.then(function(){return this.store.load(a)}.bind(this)):this},preprocess:function(a){return a?this.then(function(b){return a(b)}):this},filter:function(a){return a?this.then(function(b){return _.isFunction(a)?_.filter(b,a):_.filter(b,function(b){return g(a,b)})}):this},groupBy:function(a){return this.then(function(b){if(a){var d={},e={};_.isString(a)&&(a=[a]),_.isArray(a)&&(a=_.object(a,_.map(a,function(a){return function(b){return b[a]}})));var f=[],g=[];return _.each(a,function(a,b){f.push(b),g.push(a)}),_.each(b,function(a){var b=c(a,f,g);e[b]||(e[b]=_.object(f,_.map(f,function(b,c){return g[c](a)})),d[b]=[]),d[b].push(a)}),d=_.map(d,function(a,b){return{meta:e[b],values:a}})}return[{meta:{},values:b}]})},reduce:function(a){return a?this.then(function(b){var c={avg:function(a,b){return c.sum(a,b)/a.length},sum:function(a,b){return _.reduce(a,function(a,c){return 0+a+c[b]},0)}};return _.each(b,function(b){var d={};_.isFunction(a.iterator)?(d=_.reduce(b.values,a.iterator,a.memo||{}),b.values=[d]):a.byColumn?(_.each(a.byColumn,function(a,e){d[e]=c[a](b.values,e)}),b.values=[d]):a.columns&&a.approach&&(_.each(a.columns,function(e){d[e]=c[a.approach](b.values,e)}),b.values=[d])}),b}):this},postprocess:function(b){return b?this.then(function(c){return a.all(_.map(c,function(a){return b(a.values,a.meta)})).then(function(a){return _.each(c,function(b,c){null!=a[c]&&(b.values=a[c])}),c})}):this},series:function(a){return this.then(function(b){function c(a){var c=_.find(b,function(b){return g(a.meta,b.meta)});return a.values=c&&c.values||[],a}return a?_.isArray(a)?b=_.map(a,c):(_.each(a,function(b,d){a[d]=_.map(b,c)}),b=a):_.each(b,function(a,b){a.key="series-"+b,a.name=_.reduce(a.meta,function(a,b,c){var d=c+"="+b;return a.length?a+", "+d:d},"")}),b})}};var g=e.matcher=function j(a,b,c){function d(a,c){var d=e[a]||f[a];if(d)return d(c);var g=_.isObject(c)&&!(c instanceof Date)&&!_.isArray(c);return g?j(c,b,a):_.isEqual(h(b,a),c)}var e={$and:function(a){return _.reduce(a,function(a,b,c){return a&&d(c,b)},!0)},$or:function(a){return _.reduce(a,function(a,b,c){return a||d(c,b)},!1)},$not:function(a){return!e.$and(a)},$nor:function(a){return _.reduce(a,function(a,b,c){return a&&!d(c,b)},!0)}},f={$gt:function(a){return h(b,c)>a},$gte:function(a){return h(b,c)>=a},$lt:function(a){return h(b,c)<a},$lte:function(a){return h(b,c)<=a},$in:function(a){return _.indexOf(a,h(b,c))>=0},$ne:function(a){return h(b,c)!==a},$nin:function(a){return-1===_.indexOf(a,h(b,c))}};return e.$and(a)},h=e.resolve=function(a,b){if(a){if(a[b])return a[b];var c=b.split(".");return _.reduce(c,function(a,b){return a&&a[b]},a)}}}(_,RSVP,d3,this);
//# sourceMappingURL=DataManager.min.js.map