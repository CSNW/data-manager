/*! DataManager - v0.7.0
 * https://github.com/CSNW/DataManager
 * License: MIT
 */

!function(_,a,d3,b){"use strict";var c=function i(){this.cache={},this.types=_.clone(i.types)},d=b.DataManager=c;d.Store=c,c.types={Number:function(a){return+a},Boolean:function(a){return a.toUpperCase?"TRUE"===a.toUpperCase():1===a||a===!0},String:function(a){return null==a?"":""+a},Date:function(a){return new Date(a)}},c.load=function(b){return new a.Promise(function(a,c){d3.csv(b).get(function(b,d){return b?c(b):void a(d)})})},c.processRows=function(a,b){var c=a._cast||b._cast,d=a._map||b._map;if(c||d){for(var e=a.values,f=-1,g=e.length,h=d?d.count:1,i=new Array(g*h);++f<g;)i[f*h]=c?c(e[f],f,a):e[f],d&&d(i,f*h,i[f*h],f,a);a.values=i}return a.values},c.generateMap=function(a){a=a||{};var b;if(_.isFunction(a))return b=function(b,c,d,e,f){b[c]=a(d,e,f)},b.count=1,b;var c=[],d=[];_.each(a,function(a,b){_.isObject(a)?d.push(_.extend({to:b},a)):c.push({to:b,from:a})}),d.length&&(d=_.reduce(d,function(a,b){return _.chain(a).map(function(a){return _.map(b.columns,function(c){var d={};return b.categories?d=b.categories[c]:b.category&&(d[b.category]=c),{mapping:a.mapping.concat([{from:c,to:b.to}]),categories:_.extend({},a.categories,d)}})}).flatten(!0).value()},[{mapping:[],categories:{}}]));var e="";c.length&&(e+=_.map(c,function(a){return"row['"+a.to+"'] = "+h.resolve(a.from)+";"}).join("\n"),e+=d.length?"\n\n":"out[cursor] = row;"),d.length&&(e+=_.map(d,function(a,b){return"out[cursor + "+b+"] = "+(b>0?"clone(row)":"row")+";"}).join("\n")+"\n\n",e+=_.map(d,function(a,b){var c=_.map(a.mapping,function(a){return"out[cursor + "+b+"]['"+a.to+"'] = "+h.resolve(a.from)+";"}).join("\n"),d=_.map(a.categories,function(a,c){return"out[cursor + "+b+"]['"+c+"'] = "+h.value(a)+";"}).join("\n");return c+"\n"+d}).join("\n\n"));var f=new Function("resolve","clone","out","cursor","row","index",e);return b=function(a,b,c,d){return c?f(g.resolve,g.cloneObject,a,b,c,d):void 0},b.count=d.length||1,b},c.generateCast=function(a,b){if(_.isFunction(a))return a;var c={};_.each(a,function(a,d){c[d]=_.isFunction(a)?a:b[a]});var d=_.map(_.keys(c),function(a){return"row['"+a+"'] = cast_options['"+a+"'](row['"+a+"'], index, details);"}).join("\n");d+="return row;";var e=new Function("cast_options","row","index","details",d);return function(a,b,d){return a?e(c,a,b,d):void 0}},_.extend(c.prototype,{values:function(){return new a.Promise(function(a){a(this.cache)}.bind(this))},load:function(b,d){var e=_.isArray(b)?b:[b];d=d||{},d.cast&&(d._cast=c.generateCast(d.cast,this.types)),d.map&&(d._map=c.generateMap(d.map));var f=_.map(e,function(b){var e=this.cache[b];return e||(e=this.cache[b]={filename:b,values:[]}),_.extend(e,d),e.loaded?(d.cast||d.map)&&(e.loading=new a.Promise(function(a,b){_.defer(function(){try{c.processRows(e,this),e.loading=null,a(e.values)}catch(d){b(d)}}.bind(this))}.bind(this))):e.loading||(e.loading=c.load(b).then(function(a){return e.values=a,c.processRows(e,this),e.loading=null,e.loaded=new Date,e.values}.bind(this))),e.loading},this);return a.all(f).then(function(){return _.pick(this.cache,e)}.bind(this))},cast:function(a){return this._cast=c.generateCast(a,this.types),this},map:function(a){return this._map=c.generateMap(a),this},query:function(a){return new e(this,a)}});var e=d.Query=function(b,c){this.store=b,this.promise=new a.Promise(function(a){a(b.cache)}),c&&this.from(c.from).then(function(a){return _.flatten(_.pluck(_.values(a),"values"))}).preprocess(c.preprocess).filter(c.filter).groupBy(c.groupBy).reduce(c.reduce).postprocess(c.postprocess).series(c.series)};_.extend(e.prototype,{then:function(){return this.promise=this.promise.then.apply(this.promise,arguments),this},"catch":function(){return this.promise=this.promise["catch"].apply(this.promise,arguments),this},"finally":function(){return this.promise=this.promise["finally"].apply(this.promise,arguments),this},from:function(a){return a?this.then(function(){return this.store.load(a)}.bind(this)):this},preprocess:function(a){return a?this.then(function(b){return a(b)}):this},filter:function(a){return a?this.then(function(b){if(_.isFunction(a))return _.filter(b,a);var c=f(a);return _.filter(b,c)}):this},groupBy:function(a){return this.then(function(b){if(a){var c={},d={};_.isString(a)&&(a=[a]),_.isArray(a)&&(a=_.object(a,_.map(a,function(a){return function(b){return b[a]}})));var e=[],f=[];return _.each(a,function(a,b){e.push(b),f.push(a)}),_.each(b,function(a){var b=g.quickKey(a,e,f);d[b]||(d[b]=_.object(e,_.map(e,function(b,c){return f[c](a)})),c[b]=[]),c[b].push(a)}),c=_.map(c,function(a,b){return{meta:d[b],values:a}})}return[{meta:{},values:b}]})},reduce:function(a){return a?this.then(function(b){var c={avg:function(a,b){return c.sum(a,b)/a.length},sum:function(a,b){return _.reduce(a,function(a,c){return 0+a+c[b]},0)}};return _.each(b,function(b){var d={};_.isFunction(a.iterator)?(d=_.reduce(b.values,a.iterator,a.memo||{}),b.values=[d]):a.byColumn?(_.each(a.byColumn,function(a,e){d[e]=c[a](b.values,e)}),b.values=[d]):a.columns&&a.approach&&(_.each(a.columns,function(e){d[e]=c[a.approach](b.values,e)}),b.values=[d])}),b}):this},postprocess:function(b){return b?this.then(function(c){return a.all(_.map(c,function(a){return b(a.values,a.meta)})).then(function(a){return _.each(c,function(b,c){null!=a[c]&&(b.values=a[c])}),c})}):this},series:function(a){return this.then(function(b){function c(a){var c=f(a.meta),d=_.find(b,function(a){return c(a.meta)});return a.values=d&&d.values||[],a}return a?_.isArray(a)?b=_.map(a,c):(_.each(a,function(b,d){a[d]=_.map(b,c)}),b=a):_.each(b,function(a,b){a.key="series-"+b,a.name=_.reduce(a.meta,function(a,b,c){var d=c+"="+b;return a.length?a+", "+d:d},"")}),b})}});var f=d.matcher=function(a){function b(a,e,f){var g=c[a]||d[a];if(g)return g(e,f);var i=_.isObject(e)&&!(e instanceof Date)&&!_.isArray(e);return i?b("$and",e,a):h.equal(a,e)}var c={$and:function(a,c){return"("+_.map(a,function(a,d){return b(d,a,c)}).join(") && (")+")"},$or:function(a,c){return"("+_.map(a,function(a,d){return b(d,a,c)}).join(") || (")+")"},$not:function(a,c){return"!(("+_.map(a,function(a,d){return b(d,a,c)}).join(") && (")+"))"},$nor:function(a,c){return"!("+_.map(a,function(a,d){return b(d,a,c)}).join(") && !(")+")"}},d={$gt:function(a,b){return h.resolve(b)+" > "+h.value(a)},$gte:function(a,b){return h.resolve(b)+" >= "+h.value(a)},$lt:function(a,b){return h.resolve(b)+" < "+h.value(a)},$lte:function(a,b){return h.resolve(b)+" <= "+h.value(a)},$in:function(a,b){return h.indexOf(b,a)+" >= 0"},$ne:function(a,b){return"!"+h.equal(b,a)},$nin:function(a,b){return h.indexOf(b,a)+" === -1"}},e=new Function("row","resolve","equal","indexOf","return "+b("$and",a)+";");return function(a){return a?e(a,g.resolve,g.equal,g.indexOf):!1}},g=d.utils={};g.resolve=function(a,b){if(a){if(a[b])return a[b];var c=b.split(".");return _.reduce(c,function(a,b){return a&&a[b]},a)}},g.quickKey=function(a,b,c){for(var d=[],e=0,f=b.length;f>e;e++)d.push(b[e]+":"+c[e](a));return d.join("&")},g.cloneObject=function(a){var b={};for(var c in a)b[c]=a[c];return b},g.equal=_.isEqual,g.indexOf=_.indexOf;var h=d.builder={};h.value=function(a){return _.isString(a)?"'"+a+"'":a instanceof Date?"new Date('"+a.toJSON()+"')":_.isObject(a)?JSON.stringify(a):a},h.resolve=function(a){return a.indexOf(".")>=0?"resolve(row, '"+a+"')":"row['"+a+"']"},h.equal=function(a,b){return"equal("+h.resolve(a)+", "+h.value(b)+")"},h.indexOf=function(a,b){return"indexOf("+h.value(b)+", "+h.resolve(a)+")"}}(_,RSVP,d3,this);
//# sourceMappingURL=DataManager.min.js.map